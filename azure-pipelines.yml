trigger:
  - develop

variables:
  - group: TextCheckIn-Development
  # Agent VM image name
  - name: vmImageName
    value: "windows-latest"
  # Working Directory - adjusted to find project files
  - name: workingDirectory
    value: "$(System.DefaultWorkingDirectory)"

stages:
  - stage: Build
    displayName: Build stage

    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: UseDotNet@2
            displayName: "Use .NET 8 SDK"
            inputs:
              packageType: "sdk"
              version: "8.0.x"

          - task: DotNetCoreCLI@2
            displayName: "Restore"
            inputs:
              command: "restore"
              projects: "src/**/*.csproj"
              feedsToUse: "select"

          - task: DotNetCoreCLI@2
            displayName: Build
            inputs:
              command: "publish"
              publishWebProjects: false
              projects: "src/TextCheckIn.Functions/TextCheckIn.Functions.csproj"
              arguments: "--configuration Release --output $(Build.ArtifactStagingDirectory)/publish_output --runtime win-x64 --self-contained false"
              zipAfterPublish: false
              modifyOutputPath: false

          - task: ArchiveFiles@2
            displayName: "Archive files"
            inputs:
              rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish_output"
              includeRootFolder: false
              archiveType: zip
              archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
            artifact: drop

  - stage: Deploy
    displayName: Deploy stage
    dependsOn: Build
    condition: succeeded()

    jobs:
      - deployment: Deploy
        displayName: Deploy
        environment: "production"
        pool:
          vmImage: $(vmImageName)

        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureFunctionApp@2
                  displayName: "Azure Functions App Deploy: $(functionAppName)"
                  inputs:
                    connectedServiceNameARM: "$(azureSubscription)"
                    appType: "functionApp"
                    appName: "$(functionAppName)"
                    package: "$(Pipeline.Workspace)/drop/$(Build.BuildId).zip"
                    deploymentMethod: "auto"